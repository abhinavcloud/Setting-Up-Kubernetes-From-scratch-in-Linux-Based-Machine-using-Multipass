#Install Multipass and create two VMs for Kubernetes cluster:
sudo snap install multipass
multipass launch --name k8s-controlplane --cpus 2 --memory 2.5G --disk 20G
multipass launch --name k8s-worker1 --cpus 2 --memory 1.5G --disk 10G

#List all Multipass VMs and access the control plane VM:
abhinav@abhinav:~$ multipass list
Name                    State             IPv4             Image
k8s-controlplane        Running           10.64.71.3       Ubuntu 24.04 LTS
k8s-worker1             Running           10.64.71.226     Ubuntu 24.04 LTS

#Access the controlplane VM:
multipass shell k8s-controlplane
ubuntu@k8s-controlplane:~$ 
cluster-cidr=10.244.0.0/16
multipass shell k8s-worker1  


# Now you can proceed with Kubernetes installation and configuration on the VMs.

#Step 1: Prepare the node (both control plane and worker nodes)
sudo apt update && sudo apt upgrade -y
sudo swapoff -a
sudo sed -i '/swap / s/^/#/' /etc/fstab
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
cat /etc/modules-load.d/k8s.conf
sudo modprobe overlay
sudo modprobe br_netfilter
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1
EOF
sudo sysctl --system

#Step 2: Install containerd (to be done on both control plane and worker nodes)
sudo apt install -y containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd
sudo systemctl status containerd

#Step 3: Install Kubernetes components (kubeadm, kubelet, kubectl) on both nodes
sudo apt-get install -y apt-transport-https ca-certificates curl
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

#Step 4: Initialize the control plane node (on k8s-controlplane only)
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
export KUBECONFIG=/etc/kubernetes/admin.conf

#Step 5: Set up kubeconfig for the ubuntu user (on k8s-controlplane only)
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

#Step 6: Install a pod network add-on (on k8s-controlplane only)
sudo export KUBECONFIG=/etc/kubernetes/admin.conf
sudo chmod 777 /etc/kubernetes/admin.conf
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

#Step 7: Join the worker node to the cluster (on k8s-worker1)   
sudo kubeadm join 10.64.71.3:6443 --token b01qgf.vu4miuhdkzy5ldw7 \
	--discovery-token-ca-cert-hash sha256:417ec85c9db861771b1acb34c526aebf2b1d2c042de3c905b7c31b846aa27ced

#Step 8: Remove controlplane taint to allow scheduling pods (on k8s-controlplane only)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-

#Step 9: Enable Command completion for kubectl
echo 'source <(kubectl completion bash)' >>~/.bashrc
source ~/.bashrc

#Step 10: Install all Aliases for kubectl
echo 'alias k=kubectl' >>~/.bashrc
echo 'alias kgp="kubectl get pods"' >>~/.bashrc
echo 'alias kgs="kubectl get svc"' >>~/.bashrc
echo 'alias kgn="kubectl get nodes"' >>~/.bashrc
echo 'alias kctx="kubectl config use-context"' >>~/.bashrc
source ~/.bashrc   

#Step 10: To run kubectl commands on worker node without any error
#Copy the kubeconfig file from controlplane to worker node
#On controlplane node:
cat ~/.kube/config
#On worker node:
sudo mkdir -p $HOME/.kube
sudo nano $HOME/.kube/config
#Paste the copied content and save the file.
#Now you can run kubectl commands on worker node without any error.

#Step 11: Access the cluster from your local machine
#Exit from both VMs to return to your local machine.
#Install kubectl on your local machine if not already installed:
sudo snap install kubectl --classic
#Set up kubeconfig on your local machine:
#Create the .kube directory in your home folder:
mkdir -p ~/.kube
#Copy the kubeconfig from the control-plane VM to your local machine:
multipass exec k8s-controlplane -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config
#Set the correct permissions on the config file:
chmod 600 ~/.kube/config
#Add kubectl autocompletion and alias on your local machine:
echo 'source <(kubectl completion bash)' >> ~/.bashrc
echo 'alias k=kubectl' >> ~/.bashrc
echo 'complete -o default -F __start_kubectl k' >> ~/.bashrc
#Reload your bash configuration:
source ~/.bashrc
#Add all the aliases to your local machine:
cat << 'EOF' >> ~/.bashrc

# Kubernetes aliases
alias kgp='kubectl get pods'
alias kgs='kubectl get svc'
alias kgn='kubectl get nodes'
alias kgd='kubectl get deployments'
alias kdp='kubectl describe pod'
alias kds='kubectl describe service'
alias kdn='kubectl describe node'
alias kdd='kubectl describe deployment'
alias kl='kubectl logs'
alias kex='kubectl exec -it'
alias kns='kubectl config set-context --current --namespace'
alias kgc='kubectl config get-contexts'
alias ksc='kubectl config use-context'
alias kgns='kubectl get namespaces'
alias kaf='kubectl apply -f'
alias kdf='kubectl delete -f'

# Kubernetes debugging aliases
alias kdebug='kubectl run -i --tty --rm debug --image=busybox --restart=Never -- sh'
alias knrunning='kubectl get pods --field-selector=status.phase!=Running'
alias kfails='kubectl get po -A --field-selector status.phase=Failed'

# Watch commands
alias kwp='kubectl get pods -A -o wide --watch'
alias kwn='kubectl get nodes -o wide --watch'
EOF
#Apply the changes:
source ~/.bashrc
#Verify kubectl can access the cluster:
kubectl get nodes

